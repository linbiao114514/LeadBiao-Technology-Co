name: Android Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install buildozer==1.5.0
        pip install kivy==2.2.1
        pip install cython
        pip install python-for-android
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip build-essential git \
          libffi-dev libssl-dev python3-dev \
          autoconf automake libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev \
          libsdl2-ttf-dev openjdk-8-jdk ant
    
    - name: Accept Android SDK licenses
      run: |
        # 接受所有Android SDK许可证
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
        # 明确安装所需的构建工具版本
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;36.1.0" "platform-tools" "platforms;android-34"
    
    - name: Configure Buildozer
      run: |
        # 配置使用系统已安装的ANT
        echo "android.ant_path = /usr/share/ant" >> buildozer.spec
        # 配置使用系统NDK，避免下载
        echo "android.ndk_path = $ANDROID_NDK_HOME" >> buildozer.spec
        # 配置使用系统SDK，避免下载
        echo "android.sdk_path = $ANDROID_HOME" >> buildozer.spec
    
    - name: Clean previous builds
      run: |
        echo "Cleaning previous builds..."
        rm -rf .buildozer bin
    
    - name: Build with Buildozer
      run: |
        echo "=== BUILD START ==="
        echo "Current directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "Buildozer version: $(buildozer --version)"
        
        # 显示环境变量
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
        echo "ANT_HOME: $ANT_HOME"
        
        # 创建必要的目录
        mkdir -p .buildozer/android/platform
        
        # 运行Buildozer构建，增加超时和详细输出
        timeout 30m buildozer android debug --verbose
        
        echo "=== BUILD END ==="
        
        # 检查构建结果
        echo "=== Checking Build Results ==="
        ls -la
        ls -la bin/ || echo "bin directory not found"
        find . -name "*.apk" -type f || echo "No APK files found"
        
        # 显示构建日志
        cat .buildozer/android/build.log 2>/dev/null || echo "No build log found"
        
        # 检查是否生成了APK
        if [ -d "bin" ] && [ -n "$(ls -A bin 2>/dev/null)" ]; then
          echo "SUCCESS: APK generated successfully!"
          ls -la bin/
        else
          echo "ERROR: No APK generated!"
          exit 1
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: lingbiao-mobile-debug.apk
        path: bin/*.apk
        retention-days: 5